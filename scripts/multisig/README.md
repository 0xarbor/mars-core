# Multisig

## Dependencies

- Go
- terracli

### Install Go

Follow instructions at https://golang.org/dl/

### Install terracli

Run the following commands in a terminal:

```sh
git clone https://github.com/terra-money/core.git
cd core
make
```

Test that the installation was successful by running:

```sh
terracli
```

# Instructions for multisig key holders

As a multisig key holder, you will be required to sign transactions.
The instructions below explain how to do this.

## Setup key in terracli

- Setup a new private key

```sh
terracli keys add <name>
```

- Or recover an existing private key

```sh
terracli keys add <name> --recover
# Then enter your 24 word mnemonic
```

- Check the key was added and export the public key (`pubkey`)

```sh
terracli keys show <name>
```

## Create a signature for a transaction

You will be sent:
- An unsigned transaction `.json` file
- A signing command that will look similar to this:

```sh
# Set `from` to your address that is a key to the multisig: terra1multisig

from=terra1...

terracli tx sign unsigned_tx.json \
  --multisig=terra1multisig \
  --from=$from \
  ...
```

You need to:
- Open a terminal
- Change directory to the location of the `unsigned_tx.json` file

```sh
cd path/to/directory
```

- Replace `terra1...` in the signing command with your address. If your address is `terra1youraddress`, then do:

```sh
from=terra1youraddress
```

- Run the modified signing command

```sh
from=terra1youraddress

terracli tx sign unsigned_tx.json \
  --multisig=terra1multisig \
  --from=$from \
  ...
```

- Return the signature file that is generated by running the command (e.g. `terra1youraddress_sig.json`)

# Instructions for creators of multisig transactions

As a multisig transaction creator, you will be required to create unsigned transactions.
The instructions below explain how to do this.

## Create a multisig in terracli

- Collect public keys (`terrapub1add...`) of private keys that will be signers on the multisig. Ask key holders to send the output of the following command:

```sh
terracli keys show <name>
```

- Add the public keys to terracli:

```sh
terracli keys add <name> --pubkey terrapub1add...
```

- Create a multisig from the public keys:

```sh
terracli keys add <multisig_name> \
  --multisig <name_1>,<name_2>[,<name_3>...] \
  --multisig-threshold <k>
```

- Before the multisig can be used, it must be created on chain by sending some funds to its address. These funds can then be used to pay transaction fees.

## Create an unsigned transaction

- Populate a `.env` file with the required environment variables from `create_unsigned_tx.ts`
- Create an unsigned transaction (`unsigned_tx.json`):

```sh
ts-node create_unsigned_tx.ts
```

- Distribute the following to multisig key holders:
  - `unsigned_tx.json`
  - The command that was printed to stdout by `create_unsigned_tx.ts`

## Broadcast a transaction

- Collect signatures from multisig key holders
- Populate a `.env` file with the required environment variables from `broadcast_tx.ts`
- Sign the transaction and broadcast it to the network:

```sh
ts-node broadcast_tx.ts
```
